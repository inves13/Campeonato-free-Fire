<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Plataforma de Investimento — Campeonato</title>

<!-- Fonte + Ícones -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- QRCode lib (gera o QR do PIX) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  /* ==========================
     VARS & RESET
     ========================== */
  :root{
    --bg:#f5f7fb;
    --card:#ffffff;
    --text:#1f2937;
    --muted:#6b7280;
    --green:#16a34a;
    --green-dark:#0f7a37;
    --line:#e5e7eb;
    --success:#22c55e;
    --danger:#ef4444;
    --radius:16px;
    --shadow:0 8px 24px rgba(0,0,0,.08);
    --glass: rgba(255,255,255,0.85);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{ margin:0; font-family:'Poppins',sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }

  /* ==========================
     HEADER
     ========================== */
  header{
    background:linear-gradient(180deg, var(--green-dark), #0c5c2a);
    color:#fff; padding:20px 18px; text-align:center;
    border-bottom-left-radius:20px; border-bottom-right-radius:20px; box-shadow:var(--shadow);
    position:sticky; top:0; z-index:20;
  }
  header h1{margin:0 0 4px 0; font-size:20px; font-weight:600}
  header p{margin:0; font-size:13px; opacity:.95}

  main{ padding:18px; padding-bottom:110px; max-width:960px; margin:0 auto; }

  /* ==========================
     CARDS & LAYOUT
     ========================== */
  .card{
    background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow);
    padding:16px; margin-bottom:14px;
  }
  h2{font-size:18px; color:var(--green-dark); margin:10px 0 12px}
  h3{font-size:16px; color:var(--text); margin:4px 0 10px}

  .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center; }
  @media (max-width:560px){ .row{ grid-template-columns:1fr } }

  input, select, button, textarea{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--line); font-size:15px;
    background:#fff; color:var(--text);
  }
  input:focus, select:focus, textarea:focus{ outline:3px solid rgba(34,197,94,.12); border-color:var(--success) }

  .btn{
    background:var(--green); color:#fff; border:none; font-weight:600; cursor:pointer; transition:.18s;
    box-shadow:0 6px 16px rgba(22,163,74,.18);
    padding:12px 14px; border-radius:12px;
  }
  .btn[disabled]{ opacity:.6; cursor:not-allowed; transform:none; box-shadow:none }
  .btn:hover:not([disabled]){ background:var(--green-dark); transform:translateY(-2px) }
  .btn-outline{ background:#fff; color:var(--green); border:1px solid var(--green); }
  .btn-outline:hover{ color:#fff; background:var(--green) }

  .muted{ color:var(--muted); font-size:13px }

  /* ==========================
     PIX / QR
     ========================== */
  .pix-container{ text-align:center }
  .pix-grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
  .pix-code{
    background:#f8fafc; border:1px solid var(--line); padding:12px; border-radius:12px; font-size:14px; word-break:break-all; text-align:left;
  }
  .qr-box{ display:flex; align-items:center; justify-content:center; padding:12px; background:#fff; border:1px solid var(--line); border-radius:12px; }

  /* ==========================
     NAV
     ========================== */
  nav{
    position:fixed; bottom:10px; left:50%; transform:translateX(-50%); z-index:30;
    background:linear-gradient(180deg,#0b4d2a,#083f20);
    border-radius:999px; padding:8px; box-shadow:0 8px 30px rgba(2,40,20,.35);
  }
  .nav-wrap{ max-width:860px; display:flex; gap:6px; align-items:center; }
  nav button{
    background:none; border:none; color:#dff6ea; font-size:12px; cursor:pointer;
    display:flex; flex-direction:column; align-items:center; gap:4px; padding:8px 12px; border-radius:12px; transition:.15s;
  }
  nav button i{ font-size:16px; }
  nav button.active, nav button:hover{ background:rgba(255,255,255,.04); color:#fff; transform:translateY(-3px) }

  /* ==========================
     HISTORY
     ========================== */
  .history{ max-height:260px; overflow:auto; display:grid; gap:8px; padding-right:6px; }
  .history .item{ background:#f8fafc; border:1px dashed var(--line); padding:10px; border-radius:12px; font-size:14px; color:var(--text) }

  /* ==========================
     MESSAGES & TOAST
     ========================== */
  .msg {
    border-radius:10px; padding:10px 12px; margin-top:10px; display:none; font-size:14px;
  }
  .msg.show{ display:block; }
  .msg.error{ background: #fff0f0; color:var(--danger); border:1px solid rgba(239,68,68,.12) }
  .msg.success{ background: #f0fff5; color:var(--success); border:1px solid rgba(34,197,94,.12) }

  .toast{
    position:fixed; bottom:86px; left:50%; transform:translateX(-50%) translateY(20px);
    background:#062e17; color:#d1fae5; padding:10px 14px; border-radius:12px; box-shadow:var(--shadow);
    opacity:0; pointer-events:none; transition:.25s; z-index:40; font-size:14px;
  }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(0); pointer-events:auto }

  /* small helper */
  .muted-small{ color:var(--muted); font-size:12px; margin-top:6px }
  label{ font-size:13px; margin-bottom:6px; display:block; color:var(--text); font-weight:600; }
  .sr-only{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>

<!-- ==========================
     AUTH (cadastro + login)
     - agora com forms sem dependência de alert()
     - mensagens inline para feedback
     ========================== -->
<div id="authContainer" class="card" style="max-width:520px;margin:20px auto;">
  <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;">
    <div>
      <h2 style="margin:0;color:var(--green-dark)">Cadastro</h2>
      <div class="muted-small">Crie sua conta para participar do campeonato</div>
    </div>
    <div class="muted-small">Já tem conta? Use o formulário de login abaixo</div>
  </div>

  <!-- mensagens gerais -->
  <div id="authMsg" class="msg" role="alert" aria-live="polite"></div>

  <!-- Formulário registro (substitui o uso de alert) -->
  <form id="registerForm" aria-label="Formulário de cadastro" style="margin-top:12px;">
    <div class="row">
      <div>
        <label for="registerFullName">Nome completo</label>
        <input id="registerFullName" name="fullName" type="text" placeholder="Nome completo" required />
      </div>
      <div>
        <label for="registerPlayerName">Nome do jogador</label>
        <input id="registerPlayerName" name="playerName" type="text" placeholder="Nome do jogador" required />
      </div>
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label for="registerPlayerID">ID do jogador</label>
        <input id="registerPlayerID" name="playerID" type="text" placeholder="ID do jogador" required />
      </div>
      <div>
        <label for="registerPhone">Telefone</label>
        <input id="registerPhone" name="phone" type="tel" placeholder="(99) 9xxxx-xxxx" inputmode="tel" required />
      </div>
    </div>
    <div style="margin-top:8px;">
      <label for="registerEmail">Email</label>
      <input id="registerEmail" name="email" type="email" placeholder="seu@email.com" required />
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label for="registerPassword">Senha</label>
        <input id="registerPassword" name="password" type="password" placeholder="Senha (min 6 caracteres)" minlength="6" required />
      </div>
      <div style="align-self:end">
        <button class="btn" type="submit" id="btnRegister">Cadastrar</button>
      </div>
    </div>
  </form>

  <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

  <h2 style="margin:0;color:var(--green-dark)">Login</h2>
  <form id="loginForm" aria-label="Formulário de login" style="margin-top:10px;">
    <div>
      <label for="loginEmail">Email</label>
      <input id="loginEmail" name="loginEmail" type="email" placeholder="seu@email.com" required />
    </div>
    <div class="row" style="margin-top:8px;">
      <div>
        <label for="loginPassword">Senha</label>
        <input id="loginPassword" name="loginPassword" type="password" placeholder="Senha" required />
      </div>
      <div style="align-self:end">
        <button class="btn" type="submit" id="btnLogin">Entrar</button>
      </div>
    </div>
    <div class="muted-small" style="margin-top:8px">⚠️ Seus dados são protegidos. Use um email válido.</div>
  </form>
</div>

<!-- ==========================
     APP (visível após login)
     ========================== -->
<div id="mainContainer" style="display:none;">
  <header>
    <h1>Bem-vindo, <span id="headerName" aria-live="polite"></span></h1>
    <p>Saldo da Carteira: <strong>R$ <span id="saldo">0,00</span></strong></p>
  </header>

  <main>
    <!-- HOME -->
    <section id="home" class="card active" aria-labelledby="homeTitle">
      <h2 id="homeTitle">Home</h2>
      <div class="row">
        <div>
          <strong>Nome do jogador:</strong><br>
          <span id="homePlayerName" class="muted">—</span>
        </div>
        <div>
          <strong>ID do jogador:</strong><br>
          <span id="homePlayerID" class="muted">—</span>
        </div>
      </div>

      <div style="margin-top:12px;">
        <h3>Assistir à Live</h3>
        <button class="btn" id="btnIrLive" type="button"><i class="fa-solid fa-video"></i> &nbsp;Ir para Live</button>
      </div>
    </section>

    <!-- PERFIL -->
    <section id="perfil" class="card" aria-labelledby="perfilTitle" style="display:none;">
      <h2 id="perfilTitle">Perfil do Jogador</h2>
      <p><strong>Nome completo:</strong> <span id="profileFullName" class="muted">—</span></p>
      <p><strong>Nome do jogador:</strong> <span id="profilePlayerName" class="muted">—</span></p>
      <p><strong>ID do jogador:</strong> <span id="profilePlayerID" class="muted">—</span></p>
      <p><strong>Telefone:</strong> <span id="profilePhone" class="muted">—</span></p>
      <p><strong>Email:</strong> <span id="profileEmail" class="muted">—</span></p>
    </section>

    <!-- CARTEIRA -->
    <section id="carteira" class="card" aria-labelledby="carteiraTitle" style="display:none;">
      <h2 id="carteiraTitle">Carteira</h2>
      <div>
        <p>Saldo atual: <strong>R$ <span id="carteiraSaldo">0,00</span></strong></p>
      </div>

      <h3 style="margin-top:12px">Histórico</h3>
      <div id="historico" class="history" aria-live="polite"></div>
    </section>

    <!-- DEPÓSITO (PIX) -->
    <section id="deposito" class="card" aria-labelledby="depositoTitle" style="display:none;">
      <h2 id="depositoTitle">Depósito</h2>
      <div class="pix-container">
        <p class="muted">Escaneie o QR Code ou copie o código para pagar via PIX:</p>

        <div class="qr-box" aria-hidden="false"><div id="qrcode" aria-hidden="true"></div></div>

        <div class="pix-grid">
          <div class="pix-code" id="pixCode" role="region" aria-label="código pix"></div>
          <div class="row">
            <button class="btn" id="btnCopyPix"><i class="fa-regular fa-copy"></i> &nbsp;Copiar código</button>
            <button class="btn-outline" id="btnSharePix"><i class="fa-solid fa-share-from-square"></i> &nbsp;Compartilhar</button>
          </div>
        </div>

        <p class="label">Após o pagamento, o depósito é confirmado manualmente pelo admin.</p>
      </div>
    </section>

    <!-- RETIRADA -->
    <section id="retirada" class="card" aria-labelledby="retiradaTitle" style="display:none;">
      <h2 id="retiradaTitle">Retirada</h2>

      <!-- mensagens específicas do formulário de saque -->
      <div id="saqueMsg" class="msg" role="alert" aria-live="polite"></div>

      <div>
        <label for="nomeSaque">Nome completo</label>
        <input type="text" id="nomeSaque" placeholder="Nome completo" />

        <label for="tipoChave">Tipo de chave</label>
        <select id="tipoChave" aria-label="Tipo de chave PIX">
          <option value="">Tipo de chave</option>
          <option value="email">Email</option>
          <option value="cpf">CPF</option>
          <option value="telefone">Telefone</option>
        </select>

        <label for="chavePIX">Chave PIX</label>
        <input type="text" id="chavePIX" placeholder="Chave PIX (ex: email@ex.com ou CPF ou telefone)" />

        <label for="valorSaque">Valor do saque</label>
        <input type="number" id="valorSaque" placeholder="Valor (50-500)" min="50" max="500" />

        <div style="margin-top:10px;">
          <button class="btn" id="btnSolicitarSaque"><i class="fa-solid fa-hand-holding-dollar"></i> &nbsp;Solicitar saque</button>
        </div>
      </div>

      <h3 style="margin-top:14px">Histórico de Saques</h3>
      <div id="historicoSaque" class="history" aria-live="polite"></div>
    </section>

    <!-- LIVE -->
    <section id="live" class="card" aria-labelledby="liveTitle" style="display:none;">
      <h2 id="liveTitle">Live Free Fire</h2>
      <iframe class="live-frame" src="campeonato.html" title="Live do campeonato"></iframe>
    </section>
  </main>

  <!-- NAV -->
  <nav aria-label="Navegação principal">
    <div class="nav-wrap">
      <button data-target="home" class="active" aria-controls="home"><i class="fas fa-house"></i><span>Home</span></button>
      <button data-target="perfil" aria-controls="perfil"><i class="fas fa-user"></i><span>Perfil</span></button>
      <button data-target="carteira" aria-controls="carteira"><i class="fas fa-wallet"></i><span>Carteira</span></button>
      <button data-target="deposito" aria-controls="deposito"><i class="fas fa-money-bill-wave"></i><span>Depósito</span></button>
      <button data-target="retirada" aria-controls="retirada"><i class="fas fa-hand-holding-dollar"></i><span>Retirada</span></button>
      <button data-target="live" aria-controls="live"><i class="fas fa-video"></i><span>Live</span></button>
    </div>
  </nav>
</div>

<!-- TOAST -->
<div id="toast" class="toast" role="status" aria-live="polite">✅ Ação realizada</div>

<!-- ==========================
     FIREBASE (compat) - mantive seu config
     ========================== -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ========= CONFIG ========= */
/* manteve seu payload e firebaseConfig — só reorganizei o código para melhor leitura */
const PIX_PAYLOAD = "00020126850014br.gov.bcb.pix01367afe98b1-ad17-4884-be4d-9a77d0d107ca0223campeonato de free Fire52040000530398654045.005802BR5919Luis Nunes de Jesus6009Sao Paulo610901227-20062230519daqr7277131494591136304B771";

const firebaseConfig = {
  apiKey: "AIzaSyCSb_MpiKXQjPsImNp8uJbzhg5-Dflv42o",
  authDomain: "campeonato-free-fire.firebaseapp.com",
  databaseURL: "https://campeonato-free-fire-default-rtdb.firebaseio.com",
  projectId: "campeonato-free-fire",
  storageBucket: "campeonato-free-fire.firebasestorage.app",
  messagingSenderId: "930462286176",
  appId: "1:930462286176:web:f1907eed65a55fba625e05",
  measurementId: "G-QMFPH46V6X"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.database();

/* ========= STATE ========= */
let saldo = 0;
let historicoDeposito = [];
let historicoSaque    = [];

/* ========= UI HELPERS ========= */
const toastEl = document.getElementById('toast');
function toast(msg="Ação realizada!", time=2200){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), time);
}
function showInlineMsg(elId, message, type='error'){
  const el = document.getElementById(elId);
  if(!el) return;
  el.className = 'msg ' + (type==='error' ? 'error show' : 'success show');
  el.textContent = message;
  // remove depois de um tempo, mantendo aria-live anúncio
  setTimeout(()=> el.className = 'msg', 4500);
}

/* formatador de moeda (pt-BR) */
function moedaBRNumber(v){
  try{
    return Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2, maximumFractionDigits:2});
  }catch(e){ return Number(v||0).toFixed(2) }
}
function moedaBR(v){
  return 'R$ ' + moedaBRNumber(v);
}

/* ========= NAV / SECTIONS ========= */
const nav = document.querySelector('nav');
nav.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-target]');
  if(!btn) return;
  showSection(btn.dataset.target);
});
function showSection(id){
  // esconder todos e mostrar o selecionado
  document.querySelectorAll('main section').forEach(s=>{
    s.style.display = s.id===id ? 'block' : 'none';
  });
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  const activeBtn = document.querySelector(`nav button[data-target="${id}"]`);
  if(activeBtn) activeBtn.classList.add('active');
}
document.getElementById('btnIrLive').addEventListener('click', ()=> showSection('live') );

/* ========= PIX (QR + COPIAR + SHARE) ========= */
function setupPIX(){
  const pixEl = document.getElementById('pixCode');
  if(pixEl) pixEl.textContent = PIX_PAYLOAD;

  const qrContainer = document.getElementById("qrcode");
  if(qrContainer){
    qrContainer.innerHTML = "";
    try{
      new QRCode(qrContainer, {
        text: PIX_PAYLOAD,
        width: 200, height: 200, correctLevel: QRCode.CorrectLevel.M
      });
    }catch(e){
      // caso a lib falhe, mostramos apenas o texto
      pixEl.textContent = PIX_PAYLOAD;
    }
  }
}
document.getElementById('btnCopyPix').addEventListener('click', copiarPIX);
document.getElementById('btnSharePix').addEventListener('click', sharePIX);

function copiarPIX(){
  const text = PIX_PAYLOAD;
  if(navigator.clipboard && window.isSecureContext){
    navigator.clipboard.writeText(text).then(()=> toast("✅ Código PIX copiado!"));
  }else{
    const ta = document.createElement('textarea');
    ta.value = text; document.body.appendChild(ta); ta.select();
    try{ document.execCommand('copy'); toast("✅ Código PIX copiado!"); }catch{ showInlineMsg('authMsg','Não foi possível copiar automaticamente. Copie manualmente.','error'); }
    document.body.removeChild(ta);
  }
}
function sharePIX(){
  if(navigator.share){
    navigator.share({title:"PIX", text:"Código PIX para pagamento: "+PIX_PAYLOAD}).then(()=> toast("✅ Pronto para compartilhar!"))
      .catch(()=> { navigator.clipboard.writeText(PIX_PAYLOAD).then(()=> toast("✅ Código copiado para área de transferência!")); });
  }else{
    navigator.clipboard.writeText(PIX_PAYLOAD).then(()=> toast("✅ Código PIX copiado!"));
  }
}

/* ========= AUTH (register/login) ========= */
const registerForm = document.getElementById('registerForm');
const loginForm = document.getElementById('loginForm');
registerForm.addEventListener('submit', e=>{ e.preventDefault(); register(); });
loginForm.addEventListener('submit', e=>{ e.preventDefault(); login(); });

function register(){
  const btn = document.getElementById('btnRegister'); btn.disabled = true;
  const fullName  = document.getElementById('registerFullName').value.trim();
  const playerName= document.getElementById('registerPlayerName').value.trim();
  const playerID  = document.getElementById('registerPlayerID').value.trim();
  const phone     = document.getElementById('registerPhone').value.trim();
  const email     = document.getElementById('registerEmail').value.trim();
  const password  = document.getElementById('registerPassword').value;

  // validação simples no front
  if(!fullName || !playerName || !playerID || !phone || !email || !password){
    showInlineMsg('authMsg','Preencha todos os campos.','error'); btn.disabled = false; return;
  }
  if(password.length < 6){ showInlineMsg('authMsg','Senha deve ter pelo menos 6 caracteres.','error'); btn.disabled = false; return; }

  auth.createUserWithEmailAndPassword(email, password).then(cred=>{
    const uid = cred.user.uid;
    return db.ref('usuarios/'+uid).set({
      nome: fullName, playerName, idJogo: playerID, telefone: phone, email,
      saldo: 0, depositos:{}, saques:{}
    }).then(()=>{
      showInlineMsg('authMsg','🎉 Cadastro realizado! Redirecionando...', 'success');
      document.getElementById('authContainer').style.display='none';
      document.getElementById('mainContainer').style.display='block';
      loadUserData(uid);
    });
  }).catch(err=>{
    showInlineMsg('authMsg', err.message || 'Erro ao criar conta', 'error');
  }).finally(()=> btn.disabled = false);
}

function login(){
  const btn = document.getElementById('btnLogin'); btn.disabled = true;
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if(!email || !password){ showInlineMsg('authMsg','Preencha todos os campos do login.','error'); btn.disabled = false; return; }

  auth.signInWithEmailAndPassword(email, password).then(cred=>{
    document.getElementById('authContainer').style.display='none';
    document.getElementById('mainContainer').style.display='block';
    loadUserData(cred.user.uid);
    showInlineMsg('authMsg','Bem-vindo! Carregando seus dados...','success');
  }).catch(err=>{
    showInlineMsg('authMsg', err.message || 'Erro ao entrar', 'error');
  }).finally(()=> btn.disabled = false);
}

// manter persistência do login
auth.onAuthStateChanged(user=>{
  if(user){
    document.getElementById('authContainer').style.display='none';
    document.getElementById('mainContainer').style.display='block';
    loadUserData(user.uid);
  }
});

/* ========= DATA BIND ========= */
function loadUserData(uid){
  db.ref('usuarios/'+uid).once('value').then(snap=>{
    if(!snap.exists()) { showInlineMsg('authMsg','Usuário não encontrado!','error'); return; }
    const u = snap.val();

    document.getElementById('headerName').textContent = u.nome || '';
    document.getElementById('homePlayerName').textContent = u.playerName || '';
    document.getElementById('homePlayerID').textContent   = u.idJogo || '';
    document.getElementById('profileFullName').textContent= u.nome || '';
    document.getElementById('profilePlayerName').textContent = u.playerName || '';
    document.getElementById('profilePlayerID').textContent   = u.idJogo || '';
    document.getElementById('profilePhone').textContent      = u.telefone || '';
    document.getElementById('profileEmail').textContent      = u.email || '';

    saldo = Number(u.saldo||0);
    historicoDeposito = u.depositos ? Object.values(u.depositos).map(dep=>({
        text:`Depósito: ${moedaBRNumber(dep.valor)} — ${dep.status}`,
        raw:dep
      })) : [];
    historicoSaque    = u.saques    ? Object.values(u.saques).map(saq=>({
        text:`Saque: ${moedaBRNumber(saq.valor)} — ${saq.status}`,
        raw:saq
      })) : [];

    atualizarTela();
    setupPIX(); // garante PIX renderizado quando logar
  }).catch(e=>{
    showInlineMsg('authMsg','Erro ao carregar dados: '+(e.message||e),'error');
  });
}

/* ========= SAQUE ========= */
/* Mantive as regras: valor entre 50 e 500 e mesma lógica de transação */
document.getElementById('btnSolicitarSaque').addEventListener('click', solicitarSaque);

function solicitarSaque(){
  const btn = document.getElementById('btnSolicitarSaque'); btn.disabled = true;
  const nome  = document.getElementById('nomeSaque').value.trim();
  const tipo  = document.getElementById('tipoChave').value;
  const chave = document.getElementById('chavePIX').value.trim();
  const valor = parseFloat(document.getElementById('valorSaque').value);

  // validação front-end com feedback inline
  if(!nome || !tipo || !chave || isNaN(valor)){ showInlineMsg('saqueMsg','Preencha todos os campos corretamente.','error'); btn.disabled = false; return; }
  if(valor < 50 || valor > 500){ showInlineMsg('saqueMsg','O valor deve ser entre R$50 e R$500.','error'); btn.disabled = false; return; }

  const user = auth.currentUser;
  if(!user){ showInlineMsg('saqueMsg','Usuário não logado. Faça login antes.','error'); btn.disabled = false; return; }
  const uid = user.uid;

  // transaction para garantir atomicidade
  db.ref('usuarios/'+uid+'/saldo').transaction(balance=>{
    if((balance||0) < valor){ showInlineMsg('saqueMsg','Saldo insuficiente.','error'); return balance; }
    return (balance||0)-valor;
  }, (error, committed, snap)=>{
    if(error) { showInlineMsg('saqueMsg','Erro ao processar saque.','error'); btn.disabled = false; return; }
    if(committed){
      saldo = Number(snap.val()||0);
      const novoSaque = {nome, tipo, chave, valor, status:"Aguardando", date:new Date().toISOString()};
      db.ref('usuarios/'+uid+'/saques').push(novoSaque).then(()=>{
        historicoSaque.push({text:`Saque: ${moedaBRNumber(valor)} — Aguardando`, raw: novoSaque});
        atualizarTela();
        // limpar inputs
        document.getElementById('nomeSaque').value='';
        document.getElementById('tipoChave').value='';
        document.getElementById('chavePIX').value='';
        document.getElementById('valorSaque').value='';
        showInlineMsg('saqueMsg','📩 Solicitação enviada! Aguarde processamento.','success');
        toast('Solicitação enviada!');
      }).catch(e=>{
        showInlineMsg('saqueMsg','Erro ao registrar saque: '+(e.message||e),'error');
      }).finally(()=> btn.disabled = false);
    }else{
      btn.disabled = false;
    }
  });
}

/* ========= UI UPDATE ========= */
function atualizarTela(){
  // exibe apenas os números sem "R$" no header como antes (você pode ajustar)
  const saldoStr = moedaBRNumber(saldo);
  document.getElementById('saldo').textContent = saldoStr;
  document.getElementById('carteiraSaldo').textContent = saldoStr;

  document.getElementById('historico').innerHTML = historicoDeposito.length
    ? historicoDeposito.map(t=>`<div class="item">${t.text}</div>`).join('')
    : '<div class="muted">Sem movimentos ainda.</div>';

  document.getElementById('historicoSaque').innerHTML = historicoSaque.length
    ? historicoSaque.map(t=>`<div class="item">${t.text}</div>`).join('')
    : '<div class="muted">Nenhum saque solicitado.</div>';
}

/* ========= INIT ========= */
document.addEventListener('DOMContentLoaded', ()=>{
  setupPIX();
  // manter acessibilidade inicial: coloca foco no email do login
  document.getElementById('loginEmail').focus();
});
</script>
</body>
</html>
